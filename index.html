<!DOCTYPE html>
<html>
<head>
	<meta charset='UTF-8'>
	
	<title>LoRMIKA Prototype</title>
	
</head>
<style>
            svg {
    display: block;
    margin: 0 auto;
}
        body {
            font: 16px Calibri;
        }
        select {
            display: block;
            margin: 0 auto;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #;
            shape-rendering: crispEdges;
        }
        .tooltip {
        position: absolute;
        font-size: 12px;
        width:  auto;
        height: auto;
        pointer-events: none;
        background-color: white;
    }

.bubbles {
  stroke-width: 2px;
  stroke: white;
}
.bubbles:hover {
  stroke: black;
}
.center-div
{
     margin: 0 auto;
     max-width: 1280px;
     width:80%;
}
.text-div
{
     margin: 0 auto;
     max-width: 1280px;
     width:80%;
}
table {
  font-family: Calibri, Calibri;
  border-collapse: collapse;
    max-width: 1024px;
  width: 70%;
  margin: 0 auto;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
        </style>

<body>
    <div class='center-div'>
    <h1 align:'center'>LorMIKA explainer visualisation</h1>
    <h2>Introduction</h2>
    LoRMIKA is a state of the art local explainer that seeks to utilise association rules to explain a black-box model. The example used here assumes a patient who has been predicted to have a non-survival, with a probability of survival of 0.3 and a probability of death of 0.7.<br><br>
    <h2>Rulesets and Measurements</h2>
	<p>LorMIKA uses association rules to explain a black box model. There are four rule sets, namely:<br><br><b>Supporting Rules (TT):</b> Rules that support the outcome of the black-box model, i.e rules that support the patient predicted to die with a probability of 0.7. 
        <br><br><b>Contradicting Rules (TF):</b> Rules that explains the the counter-argument, that is rules that support the prediction of 0.3 probability of survival.
        <br><br><b>Hypothetical Supporting Rules (FT): </b>These rules are the hypothetical rules that would further support the current prediction, i.e. the features are do not appear in the supporting rules but can be used to support the prediction are listed here.<br><br><b>Counterfactual rules (FF):</b> LoRMIkA utilises counterfactual rules that would contradict the prediction of the patient being dead, that is these features would help reverse the prediction of the patient being dead with a probability of 0.7.
    <br><br><b>Strength:</b> Measures the predictive power of the rule.
    <br><br><b>Lift:</b> Measures the how interesting the ruleset is.</p>
    <br><b>This interactive visualisation can be interpreted as follows:</b> <br>1. Choose  your measurement (Lift or Strength) <br> 2. Each Bar Represents a Rule ranked by chosen measurement
<br><br><br>
    <h2>Predicted Outcome</h2>
    
	<p>The predicted outcome of this patient is died_hospital = 1. With a probability of 0.7 of patient predicted to be dead and 0.3 probabilty of survival.</p>
        </div>
    </body>
    
    <div class = 'center-div'>
        <script src="https://d3js.org/d3.v3.min.js"></script>

<body>

<head>
	<title></title>
	<style type="text/css">

	body {
		margin: auto;
		width: 650px;
		font: 12px arial;
	}

	</style>
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
   
<div id='center-div'>
<h2>Ruleset Visualisation</h2>
    <h3>Choose Ruleset and Measurements</h3> <b>Strength: </b> Indicates the predictive power of the association rules displayed<br><b>Lift</b> Indicates how interesting the association rule is. <div><select id="year"></select></div>
<svg id="chart" width="800" height="600"></svg><br>
</div>


<script type="text/javascript">

var init = [
	{"year": "TT-Strength", "name": "IF 136.700<=nalo<=136.950 THEN died_hospital = 1", "value": 1},
	{"year": "TT-Strength", "name": "IF khi>4.750 THEN died_hospital = 1","value": 1},
	{"year": "TT-Strength", "name": "IF 12.850<=rrlo<=12.980 THEN died_hospital = 1", "value": 1},
	{"year": "TT-Strength", "name": "IF 21.980<=rrhi<=22.470 THEN died_hospital = 1", "value": 1},
	{"year": "TT-Strength", "name": "IF urineop<1842.200 THEN died_hospital = 1", "value": 1},
	{"year": "TT-Strength", "name": "IF maplo<64.660 THEN died_hospital = 1", "value": 1},
	{"year": "TT-Strength", "name": "IF hrlo<67.320 THEN died_hospital = 1","value": 1},
	{"year": "TT-Lift", "name": "IF 136.700<=nalo<=136.950 THEN died_hospital = 1", "value": 1.01},
	{"year": "TT-Lift", "name": "IF khi>4.750 THEN died_hospital = 1","value": 1.01},
	{"year": "TT-Lift", "name": "IF 12.850<=rrlo<=12.980 THEN died_hospital = 1", "value": 1.01},
	{"year": "TT-Lift", "name": "IF 21.980<=rrhi<=22.470 THEN died_hospital = 1", "value": 1.01},
	{"year": "TT-Lift", "name": "IF urineop<1842.200 THEN died_hospital = 1", "value": 1.01},
	{"year": "TT-Lift", "name": "IF maplo<64.660 THEN died_hospital = 1", "value": 1.01},
	{"year": "TT-Lift", "name": "IF hrlo<67.320 THEN died_hospital = 1","value": 1.01},
    {"year": "TF-Strength", "name": "IF systoliclo>90.570 & hcthi<0.390 THEN died_hospital = 0", "value": 0.455},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 & maphi<98.920 THEN died_hospital = 0","value": 0.354},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 & wcchi<17.820 THEN died_hospital = 0", "value": 0.33},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 & diastolichi<75.640 THEN died_hospital = 0", "value": 0.326},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 & klo>3.840 THEN died_hospital = 0", "value": 0.316},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 & hmgnhi<13.110 THEN died_hospital = 0", "value": 0.284},
	{"year": "TF-Strength", "name": "IF templo>34.770 & systoliclo>90.570 THEN died_hospital = 0","value": 0.104},
    {"year": "TF-Strength", "name": "IF hcthi<0.390 THEN died_hospital = 0", "value": 0.052},
	{"year": "TF-Strength", "name": "IF systoliclo>90.570 THEN died_hospital = 0", "value": 0.045},
	{"year": "TF-Strength", "name": "IF klo>3.840 THEN died_hospital = 0","value": 0.041},
    {"year": "TF-Strength", "name": "IF wcchi<17.820 THEN died_hospital = 0", "value": 0.04},
	{"year": "TF-Strength", "name": "IF maphi<98.920 THEN died_hospital = 0", "value": 0.04},
	{"year": "TF-Strength", "name": "IF diastolichi<75.640 THEN died_hospital = 0","value": 0.039},
    {"year": "TF-Strength", "name": "IF templo>34.770 THEN died_hospital = 0","value": 0.038},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & hcthi<0.390 THEN died_hospital = 0", "value": 33.85},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & maphi<98.920 THEN died_hospital = 0","value": 24.5},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & wcchi<17.820 THEN died_hospital = 0", "value": 26.33},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & diastolichi<75.640 THEN died_hospital = 0", "value": 24.24},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & klo>3.840 THEN died_hospital = 0", "value": 21.24},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 & hmgnhi<13.110 THEN died_hospital = 0", "value": 25.15},
	{"year": "TF-Lift", "name": "IF templo>34.770 & systoliclo>90.570 THEN died_hospital = 0","value": 8.74},
    {"year": "TF-Lift", "name": "IF hcthi<0.390 THEN died_hospital = 0", "value": 3.9},
	{"year": "TF-Lift", "name": "IF systoliclo>90.570 THEN died_hospital = 0", "value": 3.32},
	{"year": "TF-Lift", "name": "IF klo>3.840 THEN died_hospital = 0","value": 6.06},
    {"year": "TF-Lift", "name": "IF wcchi<17.820 THEN died_hospital = 0", "value": 3},
	{"year": "TF-Lift", "name": "IF maphi<98.920 THEN died_hospital = 0", "value": 3},
	{"year": "TF-Lift", "name": "IF diastolichi<75.640 THEN died_hospital = 0","value": 2.89},
    {"year": "TF-Lift", "name": "IF templo>34.770 THEN died_hospital = 0","value": 2.81},
    {"year": "FT-Strength", "name": "IF 89.940<=systoliclo<=90.570 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 22.180<=hco3hi<=22.340 THEN died_hospital = 1","value": 1},
	{"year": "FT-Strength", "name": "IF 36.930<=temphi<=36.980 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 116.140<=creatlo<=122.340 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 34.740<=templo<=34.770 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 3.800<=klo<=3.840 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF templo>34.770 & systoliclo>90.570 THEN died_hospital = 1","value": 1},
    {"year": "FT-Strength", "name": "IF 142.890<=systolichi<=143.420 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 64.660<=maplo<=65.570 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF 17.820<=wcchi<=18.420 THEN died_hospital = 1","value": 1},
    {"year": "FT-Strength", "name": "IF 98.920<=maphi<=100.280 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF wcchi>18.420 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Strength", "name": "IF maphi>100.280 THEN died_hospital = 1","value": 1},
    {"year": "FT-Strength", "name": "IF diastolichi>77.880 THEN died_hospital = 1","value": 1},
    {"year": "FT-Strength", "name": "IF klo<3.800 THEN died_hospital = 1", "value": 1},
    {"year": "FT-Lift", "name": "IF 89.940<=systoliclo<=90.570 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 22.180<=hco3hi<=22.340 THEN died_hospital = 1","value": 1},
	{"year": "FT-Lift", "name": "IF 36.930<=temphi<=36.980 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 116.140<=creatlo<=122.340 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 34.740<=templo<=34.770 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 3.800<=klo<=3.840 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF templo>34.770 & systoliclo>90.570 THEN died_hospital = 1","value": 1},
    {"year": "FT-Lift", "name": "IF 142.890<=systolichi<=143.420 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 64.660<=maplo<=65.570 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF 17.820<=wcchi<=18.420 THEN died_hospital = 1","value": 1},
    {"year": "FT-Lift", "name": "IF 98.920<=maphi<=100.280 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF wcchi>18.420 THEN died_hospital = 1", "value": 1},
	{"year": "FT-Lift", "name": "IF maphi>100.280 THEN died_hospital = 1","value": 1},
    {"year": "FT-Lift", "name": "IF diastolichi>77.880 THEN died_hospital = 1","value": 1},
    {"year": "FT-Lift", "name": "IF klo<3.800 THEN died_hospital = 1", "value": 1},
    {"year": "FF-Strength", "name": "IF sex=0.000 & urineop>2010.260 & klo>3.840 THEN died_hospital = 0", "value": 0.791},
	{"year": "FF-Strength", "name": "IF diastolichi<75.640 & hco3lo<18.700 THEN died_hospital = 0","value": 0.788},
	{"year": "FF-Strength", "name": "IF sex=0.000 & nahi>140.610 & klo>3.840 THEN died_hospital = 0", "value": 0.774},
	{"year": "FF-Strength", "name": "IF sex=0.000 & maphi<98.920 & creatlo<116.140 THEN died_hospital = 0", "value": 0.761},
	{"year": "FF-Strength", "name": "IF hcthi<0.390 & wcclo>13.660 THEN died_hospital = 0", "value": 0.76},
	{"year": "FF-Strength", "name": "IF 105.170<=hrhi<=109.020 & systoliclo>90.570 & wcclo>13.660 THEN died_hospital = 0", "value": 0.752},
	{"year": "FF-Strength", "name": "IF klo>3.840 & hco3lo<18.700 THEN died_hospital = 0","value": 0.752},
    {"year": "FF-Strength", "name": "IF hco3lo<18.700 & hmgnhi<13.110 THEN died_hospital = 0", "value": 0.752},
	{"year": "FF-Strength", "name": "IF maphi<98.920 & hco3lo<18.700 THEN died_hospital = 0", "value": 0.752},
	{"year": "FF-Strength", "name": "IF sex=0.000 & hrlo>70.620 & hmgnhi<13.110 THEN died_hospital = 0","value": 0.751},
    {"year": "FF-Strength", "name": "IF sex=0.000 & urineop>2010.260 & maphi<98.920 THEN died_hospital = 0", "value": 0.751},
	{"year": "FF-Strength", "name": "IF sex=0.000 & diastolichi<75.640 & creatlo<116.140 THEN died_hospital = 0", "value": 0.754},
	{"year": "FF-Strength", "name": "IF sex=0.000 & maphi<98.920 & nahi>140.610 THEN died_hospital = 0","value": 0.74},
    {"year": "FF-Strength", "name": "IF sex=0.000 & hrlo>70.620 & maphi<98.920 THEN died_hospital = 0","value": 0.74},
    {"year": "FF-Strength", "name": "IF hco3lo<18.700 & hcthi<0.390 THEN died_hospital = 0", "value": 0.735},
    {"year": "FF-Lift", "name": "IF sex=0.000 & urineop>2010.260 & klo>3.840 THEN died_hospital = 0", "value": 58.83},
	{"year": "FF-Lift", "name": "IF diastolichi<75.640 & hco3lo<18.700 THEN died_hospital = 0","value": 58.58},
	{"year": "FF-Lift", "name": "IF sex=0.000 & nahi>140.610 & klo>3.840 THEN died_hospital = 0", "value": 57.57},
	{"year": "FF-Lift", "name": "IF sex=0.000 & maphi<98.920 & creatlo<116.140 THEN died_hospital = 0", "value": 56.61},
	{"year": "FF-Lift", "name": "IF hcthi<0.390 & wcclo>13.660 THEN died_hospital = 0", "value": 56.49},
	{"year": "FF-Lift", "name": "IF 105.170<=hrhi<=109.020 & systoliclo>90.570 & wcclo>13.660 THEN died_hospital = 0", "value": 55.91},
	{"year": "FF-Lift", "name": "IF klo>3.840 & hco3lo<18.700 THEN died_hospital = 0","value": 55.91},
    {"year": "FF-Lift", "name": "IF hco3lo<18.700 & hmgnhi<13.110 THEN died_hospital = 0", "value": 34.91},
	{"year": "FF-Lift", "name": "IF maphi<98.920 & hco3lo<18.700 THEN died_hospital = 0", "value": 55.91},
	{"year": "FF-Lift", "name": "IF sex=0.000 & hrlo>70.620 & hmgnhi<13.110 THEN died_hospital = 0","value": 55.91},
    {"year": "FF-Lift", "name": "IF sex=0.000 & urineop>2010.260 & maphi<98.920 THEN died_hospital = 0", "value": 53},
	{"year": "FF-Lift", "name": "IF sex=0.000 & diastolichi<75.640 & creatlo<116.140 THEN died_hospital = 0", "value": 52},
	{"year": "FF-Lift", "name": "IF sex=0.000 & maphi<98.920 & nahi>140.610 THEN died_hospital = 0","value": 54},
    {"year": "FF-Lift", "name": "IF sex=0.000 & hrlo>70.620 & maphi<98.920 THEN died_hospital = 0","value": 23},
    {"year": "FF-Lift", "name": "IF hco3lo<18.700 & hcthi<0.390 THEN died_hospital = 0", "value": 45},

];

chart(init)

function chart(result) {

	var format = d3.format(",.0f")

	var years = [...new Set(result.map(d => d.year))]
	var fruit = [...new Set(result.map(d => d.name))]

	var options = d3.select("#year").selectAll("option")
		.data(years)
	.enter().append("option")
		.text(d => d)

	var svg = d3.select("#chart"),
		margin = {top: 25, bottom: 10, left: 50, right: 45},
		width = +svg.attr("width") - margin.left - margin.right,
		height = +svg.attr("height") - margin.top - margin.bottom;

	var x = d3.scaleLinear()
		.range([margin.left, width - margin.right])
	
	var y = d3.scaleBand()
		.range([margin.top, height - margin.bottom])
		.padding(0.1)
		.paddingOuter(0.5)
		.paddingInner(0.5)

	var xAxis = svg.append("g")
		.attr("class", "x-axis")
		.attr("transform", `translate(0,${margin.top})`)

	var yAxis = svg.append("g")
		.attr("class", "y-axis")
		.attr("transform", `translate(${margin.left},0)`)

	update(d3.select("#year").property("value"), 750, 250)

	function update(input, speed, delay) {

		var data = result.filter(f => f.year == input)

		var sum = d3.sum(data, d => d.value)

		x.domain([0, d3.max(data, d => d.value)]).nice()

		svg.selectAll(".x-axis").transition().duration(speed)
			.call(d3.axisTop(x).tickSizeOuter(0));
			
		data.sort((a, b) => b.value - a.value)

		y.domain(data.map(d => d.name))

		svg.selectAll(".y-axis").transition().duration(speed)
			.call(d3.axisLeft(y));

		yAxis.selectAll("text").remove()
		yAxis.selectAll("line").remove()

		var bar = svg.selectAll(".bar")
			.data(data, d => d.name)

		bar.exit().remove();

		bar.enter().insert("g", ".y-axis").append("rect")
			.attr("class", "bar")
			.attr("fill", "#ffc6b6")
			.attr("x", x(0))
			.attr("y", d => y(d.name))
			.attr("height", y.bandwidth())
			.merge(bar)
		.transition().duration(speed)
			.delay((_, i) => delay * i)
			.attr("y", d => y(d.name))
			.attr("width", d => x(d.value) - x(0));

		var value = svg.selectAll(".value")
			.data(data, d => d.name)

		value.exit().remove();

		value.enter().append("text")
			.attr("class", "value")
			.attr("opacity", 0)
			.attr("dy", 4)
			.attr("y", d => y(d.name) + y.bandwidth() / 2)
			.merge(value)
		.transition().duration(speed)
			.delay((_, i) => delay * i)
			.attr("opacity", 1)
			.attr("y", d => y(d.name) + y.bandwidth() / 2)
			.attr("x", d =>  x(d.value) + 5)
			.text(d => format((d.value / sum) * 100) + " %")

		var name = svg.selectAll(".name")
			.data(data, d => d.name)

		name.exit().remove();

		name.enter().append("text")
			.attr("class", "name")
			.attr("opacity", 0)
			.attr("dy", -5)
			.attr("y", d => y(d.name))
			.merge(name)
		.transition().duration(speed)
			.delay((_, i) => delay * i)
			.attr("opacity", 1)
			.attr("y", d => y(d.name))
			.attr("x", d =>  x(0) + 5)
			.text(d => d.name)
	}

	var select = d3.select("#year")
		.style("border-radius", "5px")
		.on("change", function() {
			update(this.value, 750, 0)
		})
}

</script>
    </body></body></div></html>
